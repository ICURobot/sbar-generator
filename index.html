<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICU SBAR Report Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- 1. Add the Netlify Identity Widget script -->
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Style for the disabled overlay */
        #form-overlay {
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- 2. Add Login/Logout section -->
        <div id="auth-container" class="bg-white rounded-lg shadow-md p-4 mb-6 flex justify-between items-center">
            <div id="user-info" class="text-sm font-medium text-gray-600">Please log in to use the generator.</div>
            <button data-netlify-identity-button class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">Log In / Sign Up</button>
        </div>

        <!-- The main container for the assessment sheet -->
        <div class="relative">
            <!-- 3. Add an overlay to disable the form when logged out -->
            <div id="form-overlay" class="absolute inset-0 bg-gray-200 bg-opacity-50 z-20 flex items-center justify-center rounded-lg">
                <p class="text-lg font-bold text-gray-700">Please log in to activate the form.</p>
            </div>
            
            <div id="assessment-form" class="bg-white rounded-lg shadow-2xl p-6 md:p-8">
                <!-- Header Section -->
                <header class="border-b-2 border-gray-200 pb-4 mb-6 text-center">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">ICU SBAR Report Generator</h1>
                </header>

                <!-- All form fields go here, no changes needed to the form itself -->
                <!-- Patient Information Section -->
                <section class="grid grid-cols-2 md:grid-cols-4 gap-x-6 gap-y-4 text-sm mb-6">
                    <div class="flex items-end"><span class="font-bold mr-2">Room:</span><input id="room" class="w-full border-0 border-b border-gray-300 p-0 focus:ring-0"></div>
                    <div class="flex items-end"><span class="font-bold mr-2">Name:</span><input id="name" class="w-full border-0 border-b border-gray-300 p-0 focus:ring-0"></div>
                    <div class="flex items-end"><span class="font-bold mr-2">Age/Sex:</span><input id="age-sex" class="w-full border-0 border-b border-gray-300 p-0 focus:ring-0"></div>
                    <div class="flex items-end"><span class="font-bold mr-2">MD:</span><input id="md" class="w-full border-0 border-b border-gray-300 p-0 focus:ring-0"></div>
                    <div class="col-span-2 flex items-end"><span class="font-bold mr-2">Allergies:</span><input id="allergies" class="w-full border-0 border-b border-gray-300 p-0 focus:ring-0"></div>
                    <div class="flex items-end"><span class="font-bold mr-2">Code Status:</span><input id="code-status" class="w-full border-0 border-b border-gray-300 p-0 focus:ring-0"></div>
                    <div class="flex items-end"><span class="font-bold mr-2">Isolation:</span><input id="isolation" class="w-full border-0 border-b border-gray-300 p-0 focus:ring-0"></div>
                    <div class="col-span-2 flex items-start"><span class="font-bold mr-2 mt-1">Diagnosis:</span><textarea id="diagnosis" class="w-full h-8 border-0 border-b border-gray-300 focus:ring-0 focus:border-sky-500 resize-none p-0"></textarea></div>
                    <div class="col-span-2 flex items-start"><span class="font-bold mr-2 mt-1">History:</span><textarea id="history" class="w-full h-8 border-0 border-b border-gray-300 focus:ring-0 focus:border-sky-500 resize-none p-0"></textarea></div>
                </section>

                <!-- Main Systems Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Neurological -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h2 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">Neurological</h2>
                        <div class="space-y-3 text-sm">
                             <div><span class="font-semibold">LOC/GCS:</span> <input id="loc" class="w-full border-0 border-b p-0" placeholder="A&O x ?, GCS: E4V5M6"></div>
                             <div><span class="font-semibold">Pupils:</span> <input id="pupils" class="w-full border-0 border-b p-0" placeholder="PERRLA, 3mm, etc."></div>
                             <div><span class="font-semibold">Sedation/Pain:</span> <input id="sedation-pain" class="w-full border-0 border-b p-0" placeholder="RASS, CPOT"></div>
                             <div><span class="font-semibold">Delirium Score:</span> <input id="delirium-score" class="w-full border-0 border-b p-0" placeholder="CAM-ICU +, ICDSC score"></div>
                             <div><span class="font-semibold">EVD/ICP:</span> <input id="evd" class="w-full border-0 border-b p-0" placeholder="Clamped, ICP, drainage"></div>
                        </div>
                    </div>
                    <!-- Cardiovascular -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h2 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">Cardiovascular</h2>
                         <div class="space-y-3 text-sm">
                            <div><span class="font-semibold">HR/Rhythm:</span> <input id="hr-rhythm" class="w-full border-0 border-b p-0" placeholder="80s, NSR"></div>
                            <div><span class="font-semibold">BP/MAP:</span> <input id="bp-map" class="w-full border-0 border-b p-0" placeholder="120/80 (93)"></div>
                            <div><span class="font-semibold">Pulses:</span> <input id="pulses" class="w-full border-0 border-b p-0" placeholder="Present, +1, doppler"></div>
                            <div><span class="font-semibold">Pacemaker:</span> <input id="pacemaker" class="w-full border-0 border-b p-0" placeholder="Paced Atrial, VVI @ 70"></div>
                            <div><span class="font-semibold">IABP/Support:</span> <input id="iabp" class="w-full border-0 border-b p-0" placeholder="IABP 1:1, Impella, ECMO"></div>
                        </div>
                    </div>
                    <!-- Respiratory -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h2 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">Respiratory</h2>
                        <div class="space-y-3 text-sm">
                            <div><span class="font-semibold">Oxygen Delivery:</span> <input id="o2-delivery" class="w-full border-0 border-b p-0" placeholder="BiPAP, HFM, NC @ 2L"></div>
                            <div><span class="font-semibold">Ventilator Settings:</span><input id="vent-settings" class="w-full border-0 border-b p-0" placeholder="AC/VC, Rate 12, TV 450, PEEP 8"></div>
                            <div><span class="font-semibold">Trach/Airway:</span><input id="trach-airway" class="w-full border-0 border-b p-0" placeholder="Size 7, cuffed, last change date"></div>
                            <div><span class="font-semibold">Breath Sounds:</span><textarea id="breath-sounds" class="w-full border-0 border-b resize-none p-0" placeholder="Coarse in RLL, CTA elsewhere"></textarea></div>
                        </div>
                    </div>
                    <!-- GI/GU Section -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h2 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">GI / GU</h2>
                        <div class="space-y-3 text-sm">
                            <div><span class="font-semibold">Diet/Feeds:</span> <input id="diet" class="w-full border-0 border-b p-0" placeholder="NPO, Tube Feeds @ 50/hr"></div>
                            <div><span class="font-semibold">Abdomen/Bowel:</span> <input id="abdomen" class="w-full border-0 border-b p-0" placeholder="Soft, last BM yesterday"></div>
                            <div><span class="font-semibold">Urine Output:</span> <input id="urine-output" class="w-full border-0 border-b p-0" placeholder="Foley, >30mL/hr, clear"></div>
                        </div>
                    </div>
                    <!-- Access Section -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h2 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">Access</h2>
                         <div class="space-y-3 text-sm">
                            <div><span class="font-semibold">IV Lines:</span> <input id="iv-lines" class="w-full border-0 border-b p-0" placeholder="20g LFA, 18g RAC"></div>
                            <div><span class="font-semibold">Central Line:</span> <input id="central-line" class="w-full border-0 border-b p-0" placeholder="TLC R IJ, HD line L Fem"></div>
                            <div><span class="font-semibold">Other Drains/Tubes:</span> <input id="drains-tubes" class="w-full border-0 border-b p-0" placeholder="Chest tube, NG tube"></div>
                        </div>
                    </div>
                     <!-- Integumentary/MSK Section -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h2 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">Integumentary / MSK</h2>
                         <div class="space-y-3 text-sm">
                            <div><span class="font-semibold">Skin Integrity:</span> <input id="skin-integrity" class="w-full border-0 border-b p-0" placeholder="Sacral ulcer Stage 2, dressing CDI"></div>
                            <div><span class="font-semibold">Mobility/Strength:</span> <input id="mobility-strength" class="w-full border-0 border-b p-0" placeholder="MAE, bedrest, moves R>L"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Key Information Textareas -->
                 <section class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h2 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">Key Labs / Diagnostics</h2>
                        <textarea id="labs-diagnostics" class="w-full h-24 border rounded-lg p-2" placeholder="e.g., K: 3.2, WBC: 15.1, Lactate: 4.2..."></textarea>
                    </div>
                    <div>
                        <h2 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">Family Communication</h2>
                        <textarea id="family-communication" class="w-full h-24 border rounded-lg p-2" placeholder="Spokesperson, last update, concerns..."></textarea>
                    </div>
                </section>

                <section class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div>
                        <h2 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">IV Drips / Infusions</h2>
                        <textarea id="drips" class="w-full h-24 border rounded-lg p-2" placeholder="e.g., Norepinephrine @ 10 mcg/min..."></textarea>
                    </div>
                     <div>
                        <h2 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">Scheduled Medications</h2>
                        <textarea id="medications" class="w-full h-24 border rounded-lg p-2" placeholder="e.g., Antibiotics, PRN pain meds..."></textarea>
                    </div>
                </section>

                <section class="mt-6">
                     <h2 class="font-bold text-lg text-gray-700 mb-3 border-b pb-2">Plan for the Shift</h2>
                     <textarea id="plan" class="w-full h-24 border rounded-lg p-2" placeholder="e.g., Wean pressors, follow up on chest x-ray, consult with pharmacy..."></textarea>
                </section>

                <!-- AI Feature Button -->
                <div class="text-center mt-8">
                    <button id="generate-sbar-btn" class="bg-gradient-to-r from-teal-500 to-cyan-600 hover:from-teal-600 hover:to-cyan-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center gap-2 mx-auto">
                        âœ¨ Generate SBAR Handoff Report
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- SBAR Generation Modal -->
    <div id="sbar-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-2xl transform scale-95">
             <div class="p-6">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Generated SBAR Report</h2>
                    <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
                <div id="modal-body" class="relative">
                    <div id="loading-indicator" class="absolute inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center rounded-lg hidden">
                        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4"></div>
                        <p class="text-lg font-semibold text-gray-600">Generating report, please wait...</p>
                    </div>
                    <div id="report-content" class="space-y-4">
                        <p class="text-sm text-gray-600">Review the generated report below. You can edit it here before copying.</p>
                        <textarea id="sbar-report-text" class="w-full h-96 p-3 border rounded-md bg-gray-50 text-sm font-mono"></textarea>
                    </div>
                </div>
            </div>
            <div class="bg-gray-100 p-4 flex justify-end items-center gap-4 rounded-b-lg">
                <span id="copy-success-msg" class="text-green-600 font-semibold hidden">Copied!</span>
                <button id="copy-report-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg transition-colors">
                    Copy to Clipboard
                </button>
            </div>
        </div>
    </div>

<script>
    // --- All existing JavaScript is the same, with the addition of the auth handling ---
    const generateBtn = document.getElementById('generate-sbar-btn');
    const modal = document.getElementById('sbar-modal');
    // ... (rest of the variable declarations)
    const copySuccessMsg = document.getElementById('copy-success-msg');
    const form = document.getElementById('assessment-form');
    const formOverlay = document.getElementById('form-overlay');
    const userInfo = document.getElementById('user-info');
    const authBtn = document.querySelector('[data-netlify-identity-button]');

    // 4. JavaScript to handle login state
    function updateLoginState(user) {
        if (user) {
            // User is logged in
            userInfo.textContent = `Welcome, ${user.email}!`;
            authBtn.textContent = 'Log Out';
            formOverlay.classList.add('hidden'); // Hide the overlay
            generateBtn.disabled = false; // Enable the button
        } else {
            // User is logged out
            userInfo.textContent = 'Please log in to use the generator.';
            authBtn.textContent = 'Log In / Sign Up';
            formOverlay.classList.remove('hidden'); // Show the overlay
            generateBtn.disabled = true; // Disable the button
        }
    }
    
    // Listen for Netlify Identity events
    netlifyIdentity.on('init', user => updateLoginState(user));
    netlifyIdentity.on('login', user => {
        updateLoginState(user);
        netlifyIdentity.close(); // Close the modal on login
    });
    netlifyIdentity.on('logout', () => updateLoginState(null));


    generateBtn.addEventListener('click', handleGenerateSbar);
    // ... (rest of event listeners are the same)
    
    // --- All other functions (collectFormData, handleGenerateSbar, etc.) are the same EXCEPT for handleGenerateSbar ---
    
    function collectFormData() {
        // ... (this function is identical)
    }

    async function handleGenerateSbar() {
        const user = netlifyIdentity.currentUser();
        if (!user) {
            alert("You must be logged in to generate a report.");
            return;
        }

        const formData = collectFormData();
        if (Object.keys(formData).length === 0) {
            alert("Please fill out some patient information first.");
            return;
        }

        openModal();
        loadingIndicator.classList.remove('hidden');
        reportContent.classList.add('hidden');
        
        try {
            // The user's token is automatically sent with the request by the browser
            const response = await fetch('/.netlify/functions/generate-sbar', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${user.token.access_token}` // Pass the user's token
                },
                body: JSON.stringify({ patientData: formData })
            });

            if (!response.ok) {
                const errorData = await response.json();
                if (response.status === 401) {
                     throw new Error("Authentication error. Please log in again.");
                }
                throw new Error(errorData.error || `Request failed with status ${response.status}`);
            }

            const result = await response.json();
            sbarReportText.value = result.report;

        } catch (error) {
            console.error("Error calling backend function:", error);
            sbarReportText.value = `An error occurred: ${error.message}`;
        } finally {
            loadingIndicator.classList.add('hidden');
            reportContent.classList.remove('hidden');
        }
    }

    // ... (rest of JavaScript functions are identical)

</script>
</body>
</html>
