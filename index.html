<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- UPDATED: New Title -->
    <title>ICU SBAR Report Generator - with AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #form-overlay { backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
        /* Recording animation */
        .recording { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 10px 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Privacy Disclaimer Modal -->
    <div id="privacy-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 hidden">
        <!-- ... (privacy modal content is unchanged) ... -->
    </div>


    <div class="max-w-4xl mx-auto">
        <!-- Login/Logout section -->
        <div id="auth-container" class="bg-white rounded-lg shadow-md p-4 mb-6 flex justify-between items-center">
            <!-- ... (auth container content is unchanged) ... -->
        </div>

        <!-- NEW: Speech-to-Text Section -->
        <div id="speech-container" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">Voice Report Capture</h2>
                <button id="record-btn" class="p-3 bg-gray-200 hover:bg-gray-300 rounded-full transition-colors">
                    <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </button>
            </div>
            <textarea id="transcript-box" class="w-full h-32 p-3 border rounded-md bg-gray-50 text-sm" placeholder="Click the microphone to start speaking... your transcribed report will appear here."></textarea>
            <div id="speech-status" class="text-sm text-gray-500 mt-2 h-5"></div>
            <button id="process-transcript-btn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" disabled>
                Finish Capturing & Fill Form
            </button>
        </div>


        <!-- The main container for the assessment sheet -->
        <div class="relative">
            <!-- ... (form overlay is unchanged) ... -->
            
            <div id="assessment-form" class="bg-white rounded-lg shadow-2xl p-6 md:p-8">
                <!-- UPDATED: New Title -->
                <header class="border-b-2 border-gray-200 pb-4 mb-6 flex justify-between items-center">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">ICU SBAR Report Generator - with AI</h1>
                    <button id="clear-form-btn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-md">Clear Form</button>
                </header>

                <!-- All form fields are unchanged -->
                <!-- ... (rest of the form HTML) ... -->
                
                <div class="mt-8 text-center">
                    <button id="generate-sbar-btn" class="bg-gradient-to-r from-teal-500 to-cyan-600 hover:from-teal-600 hover:to-cyan-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center gap-2 mx-auto" disabled>
                        âœ¨ Generate SBAR Handoff Report
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- SBAR Generation Modal -->
    <div id="sbar-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <!-- ... (SBAR modal content is unchanged) ... -->
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- All existing variable declarations are the same ---
        const speechContainer = document.getElementById('speech-container');
        const recordBtn = document.getElementById('record-btn');
        const transcriptBox = document.getElementById('transcript-box');
        const speechStatus = document.getElementById('speech-status');
        const processTranscriptBtn = document.getElementById('process-transcript-btn');

        let recognition;
        let isRecording = false;

        // --- NEW Speech Recognition Logic ---
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-CA'; // Set for Canadian English

            recognition.onstart = () => {
                isRecording = true;
                speechStatus.textContent = 'Listening... Click the microphone again to stop.';
                recordBtn.classList.add('recording', 'bg-red-200');
            };

            recognition.onend = () => {
                isRecording = false;
                speechStatus.textContent = '';
                recordBtn.classList.remove('recording', 'bg-red-200');
                if (transcriptBox.value.trim().length > 0) {
                    processTranscriptBtn.disabled = false;
                }
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                transcriptBox.value = transcriptBox.value.split('...')[0] + finalTranscript + '...';
                speechStatus.textContent = 'Listening... ' + interimTranscript;
            };

            recordBtn.addEventListener('click', () => {
                if (isRecording) {
                    recognition.stop();
                } else {
                    transcriptBox.value = ''; // Clear previous transcript
                    recognition.start();
                }
            });

            processTranscriptBtn.addEventListener('click', async () => {
                const user = window.netlifyIdentity.currentUser();
                if (!user) {
                    alert("You must be logged in to process a transcript.");
                    return;
                }
                
                const transcript = transcriptBox.value.replace('...', '').trim();
                if (!transcript) return;

                processTranscriptBtn.disabled = true;
                processTranscriptBtn.textContent = 'Processing...';

                try {
                    const response = await fetch('/.netlify/functions/process-transcript', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${user.token.access_token}` },
                        body: JSON.stringify({ transcript: transcript })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || "Failed to process transcript.");
                    }
                    
                    const result = await response.json();
                    populateForm(result.formData);
                    speechStatus.textContent = 'Form filled successfully!';

                } catch (error) {
                    console.error("Error processing transcript:", error);
                    speechStatus.textContent = `Error: ${error.message}`;
                } finally {
                     processTranscriptBtn.textContent = 'Finish Capturing & Fill Form';
                }
            });

        } else {
            speechContainer.innerHTML = '<p class="text-red-500 text-center font-semibold">Speech recognition is not supported by your browser. Please use Google Chrome.</p>';
        }


        // --- All existing functions (updateLoginState, saveDraft, loadDraft, etc.) are the same ---
        // --- except updateLoginState now shows the speech container ---
        function updateLoginState(user) {
            if (user) {
                userInfo.textContent = `Welcome, ${user.email}!`;
                authBtn.textContent = 'Log Out';
                formOverlay.classList.add('hidden');
                generateBtn.disabled = false;
                speechContainer.classList.remove('hidden'); // Show the speech container
                loadDraft(user); 
            } else {
                userInfo.textContent = 'Please log in to use the generator.';
                authBtn.textContent = 'Log In / Sign Up';
                formOverlay.classList.remove('hidden');
                generateBtn.disabled = true;
                speechContainer.classList.add('hidden'); // Hide the speech container
            }
        }

        // ... (The rest of the script is identical to the previous version)
        
    });
</script>
</body>
</html>
